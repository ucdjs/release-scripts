sequenceDiagram
    participant User
    participant API as createReleaseScripts
    participant Publish as publish()
    participant IO as I/O Functions
    participant Core as Pure Functions

    User->>API: publish()
    API->>Publish: publish(config, deps)

    Publish->>IO: git.assertClean()
    Publish->>IO: git.getBranch()
    
    alt not on default branch
        Publish-->>User: throw new Error('Wrong branch')
    end

    Publish->>IO: workspace.discover()
    IO-->>Publish: packages[]

    Publish->>Publish: filter(p => !p.private)

    Publish->>Core: topologicalOrder(publicPackages)
    Core-->>Publish: ordered[]

    loop Each package in order
        Publish->>IO: npm.fetchPackument(pkg.name)
        IO-->>Publish: packument or null
        
        Publish->>Publish: check if version exists

        alt version exists
            Publish->>Publish: result = skipped
        else
            Publish->>IO: exec('pnpm', ['run', 'build'], {cwd: pkg.path})
            
            Publish->>IO: npm.publish({
                packagePath: pkg.path,
                tag: isPrerelease ? 'next' : 'latest',
                provenance: config.npm.provenance
            })
            
            alt publish success
                alt !dryRun
                    Publish->>IO: git.createTag(`${pkg.name}@${pkg.version}`)
                    Publish->>IO: git.pushTag(tag)
                end
                Publish->>Publish: result = published
            else
                Publish->>Publish: result = failed
            end
        end
    end

    Publish->>Publish: summarizeResults(results)

    alt any failed
        Publish-->>User: throw new Error('Some packages failed')
    else
        Publish-->>User: Success
    end
