# publish() Workflow - Detailed Data Flow

```mermaid
sequenceDiagram
    participant User
    participant API as ReleaseScripts API
    participant Git as GitService
    participant WS as WorkspaceService
    participant NPM as NPMService
    participant DG as DependencyGraphService

    User->>API: publish()
    
    API->>Git: workspace.assertWorkspaceReady
    
    API->>Git: branches.get
    Git-->>API: currentBranch
    
    alt currentBranch != default
        API-->>User: Throw Error("Must be on default branch")
    end
    
    API->>WS: discoverWorkspacePackages
    WS-->>API: packages
    
    API->>API: filter private packages
    
    API->>DG: topologicalOrder(publicPackages)
    DG-->>API: orderedPackages[]
    
    loop Each package in topological order
        API->>NPM: versionExists(pkg.name, pkg.version)
        NPM->>NPM: fetchPackument(pkg.name)
        NPM-->>API: boolean
        
        alt version exists
            API->>API: result = {skipped, reason: "Already published"}
        else
            API->>API: buildPackage(pkg.path)
            Note over API: pnpm run build --filter
            
            API->>NPM: publish({packagePath, tagName, provenance})
            NPM->>NPM: pnpm publish --provenance
            NPM-->>API: success | failure
            
            alt success
                alt !dryRun
                    API->>Git: tags.create(tagName)
                    API->>Git: tags.push(tagName)
                end
                API->>API: result = {published}
            else
                API->>API: result = {failed, reason}
            end
        end
    end
    
    API->>API: summarizeResults(published, skipped, failed)
    
    alt failed.length > 0
        API-->>User: Throw Error("Some packages failed")
    else
        API-->>User: Success
    end
```
