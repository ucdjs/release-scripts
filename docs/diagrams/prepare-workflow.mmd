sequenceDiagram
    actor User
    participant API as prepare()
    participant GH as GitHubService
    participant Git as GitService
    participant WS as WorkspaceService
    participant Helpers as Helper Utils
    participant VC as VersionCalculator
    participant DG as DependencyGraph
    participant PU as PackageUpdater
    participant CL as ChangelogService
    participant FS as FileSystem

    User->>API: Start preparation

    Note over API,GH: 1. Fetch Release PR
    API->>GH: getPullRequestByBranch(releaseBranch)
    alt PR exists
        GH-->>API: PR{number, head.sha}
    else No PR
        GH-->>API: null
        API-->>User: Error: Release PR does not exist
    end

    Note over API,Git: 2. Checkout and Rebase
    API->>Git: branches.checkout(releaseBranch)
    Git-->>API: On release branch
    API->>Git: branches.rebase(mainBranch)
    Note over Git: Preserves manual changes
    Git-->>API: Rebase complete

    Note over API,Helpers: 3. Load Overrides from Main
    API->>Helpers: loadOverrides(mainBranch)
    Helpers->>Git: readFile(".github/ucdjs-release.overrides.json")
    Git-->>Helpers: overrides JSON
    Helpers-->>API: overrides{}

    Note over API,Git: 4. Discover Packages from Main
    API->>Git: branches.checkout(mainBranch)
    Git-->>API: On main branch
    API->>WS: discoverWorkspacePackages()
    WS-->>API: packages[]
    API->>Helpers: mergePackageCommitsIntoPackages()
    Helpers->>Git: getCommits() for each package
    Helpers-->>API: packages with commits
    API->>Helpers: mergeCommitsAffectingGloballyIntoPackage()
    Helpers-->>API: packages with global commits

    Note over API,VC: 5. Calculate Version Bumps
    API->>VC: calculateBumps(packages, overrides)
    VC->>VC: Analyze conventional commits
    VC-->>API: releases[]
    API->>DG: topologicalOrder(packages)
    DG-->>API: ordered packages

    Note over API,Git: 6. Return to Release Branch
    API->>Git: branches.checkout(releaseBranch)
    Git-->>API: On release branch

    Note over API,PU: 7. Update package.json Files
    API->>PU: applyReleases(packages, releases)
    loop For each package (in topo order)
        PU->>WS: readPackageJson(package.path)
        WS-->>PU: packageJson
        PU->>PU: Update version and dependencies
        PU->>FS: writeFile(package.json)
        FS-->>PU: Written
    end
    PU-->>API: All packages updated

    Note over API,CL: 8. Generate Changelogs
    loop For each release
        API->>CL: generateChangelog(pkg, newVersion, commits)
        CL->>CL: createChangelog() [pure]
        CL->>CL: formatChangelogMarkdown() [pure]
        CL-->>API: {markdown, filePath}
        API->>FS: writeFile(CHANGELOG.md)
        FS-->>API: Written
    end

    Note over API,Git: 9. Stage Modified Files
    API->>Git: commits.stage([package.json, CHANGELOG.md])
    Git-->>API: Files staged

    Note over API,Git: 10. Create Commit
    API->>Git: commits.write("chore(release): prepare release")
    Git-->>API: Commit created

    Note over API,Git: 11. Force Push with Lease
    API->>Git: commits.forcePush(releaseBranch)
    Note over Git: Uses --force-with-lease
    Git-->>API: Push complete

    Note over API,GH: 12. Update PR Body
    API->>GH: generateReleasePRBody(releases)
    GH->>GH: Render Eta template
    GH-->>API: PR body markdown
    API->>GH: updatePullRequest(prNumber, {body})
    GH-->>API: PR updated

    API-->>User: âœ… Preparation complete
