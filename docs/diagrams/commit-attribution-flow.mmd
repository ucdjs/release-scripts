sequenceDiagram
    participant API as Main Workflow
    participant Helpers as Helper Utils
    participant Git as GitService
    participant Packages as Package List

    Note over API,Packages: Input: Packages with package-specific commits already merged

    API->>Helpers: mergeCommitsAffectingGloballyIntoPackage(packages, mode)

    alt mode = "none"
        Helpers-->>API: Return packages unchanged
        Note over API: No global commits added
    else mode = "all" or "dependencies"
        Note over Helpers,Git: 1. Get all commits from main branch
        Helpers->>Packages: findCommitRange(packages)
        Packages-->>Helpers: {oldest, newest} commit timestamps

        Helpers->>Git: getCommitsSince(oldestTag)
        Git-->>Helpers: allCommits[]

        Note over Helpers: 2. Filter for global commits
        loop For each commit
            Helpers->>Helpers: isGlobalCommit(commit, packages)
            alt Commit affects files outside package dirs
                Helpers->>Helpers: Mark as global commit
                alt mode = "dependencies"
                    Helpers->>Helpers: isDependencyFile(commit.files)
                    opt Is dependency file
                        Helpers->>Helpers: Keep commit
                    end
                else mode = "all"
                    Helpers->>Helpers: Keep commit
                end
            end
        end

        Note over Helpers: 3. Attribute commits to packages
        loop For each package
            Helpers->>Git: getMostRecentPackageTag(package)
            Git-->>Helpers: lastReleaseTag

            Helpers->>Git: getCommitsSince(lastReleaseTag)
            Git-->>Helpers: lastReleaseCommits[]

            Helpers->>Helpers: Find newest commit timestamp
            Note over Helpers: lastReleaseTime = newest commit time

            Note over Helpers: 4. Filter global commits by timestamp
            loop For each global commit
                alt commit.time > lastReleaseTime
                    Helpers->>Helpers: Attribute to package
                    Note over Helpers: This prevents double-counting:<br/>commit happened AFTER this<br/>package was last released
                else commit.time <= lastReleaseTime
                    Helpers->>Helpers: Skip (already counted in previous release)
                end
            end

            Helpers->>Packages: Merge attributed commits into package
        end

        Helpers-->>API: packages with global commits added
    end

    Note over API: Result: Packages with both package-specific<br/>and attributed global commits
